<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HG Interiores de Madera â€” Visor 3D</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/babylonjs/6.26.0/babylon.min.js"></script>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background-color: #2c2c2c;
    color: white;
    font-family: 'Segoe UI', sans-serif;
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  label {
    font-weight: 600;
    font-size: 12px;
    color: #aaa;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 5px;
    display: block;
  }

  input, select {
    background-color: #444;
    border: 1px solid #555;
    border-radius: 8px;
    padding: 10px 12px;
    color: white;
    font-size: 13px;
    width: 100%;
    transition: 0.2s;
    outline: none;
    font-family: 'Segoe UI', sans-serif;
  }
  input:focus, select:focus { border-color: #ffb800; background-color: #4d4d4d; box-shadow: 0 0 8px rgba(255,184,0,0.2); }
  select option { background: #383838; }
  input[readonly] { color: #aaa; cursor: default; }

  .fas { font-family:"Font Awesome 5 Free"!important; font-weight:900!important; font-style:normal; }

  /* HEADER */
  header {
    background: #1e1e1e;
    border-bottom: 2px solid #ffb800;
    padding: 0 20px;
    height: 54px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }
  .hdr-titulo { color:#ffb800; font-size:16px; font-weight:700; letter-spacing:2px; text-transform:uppercase; display:flex; align-items:center; gap:10px; }
  .hdr-right { display:flex; align-items:center; gap:10px; }
  .badge-proyecto { background:#383838; border:1px solid #555; border-radius:6px; padding:4px 14px; font-size:12px; color:#00bcff; font-weight:600; }

  .btn-hg {
    padding: 9px 16px;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
    border: none;
    transition: 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 7px;
    font-family: 'Segoe UI', sans-serif;
    font-size: 11px;
  }
  .btn-hg:hover { filter:brightness(1.2); transform:translateY(-1px); }
  .btn-hg:active { transform:scale(0.95); }
  .btn-amarillo { background:#ffb800; color:black; }
  .btn-verde    { background:#218838; color:white; }
  .btn-gris     { background:#555; color:#ccc; }

  /* LAYOUT */
  .main { display:flex; flex:1; overflow:hidden; }

  /* SIDEBAR */
  .sidebar {
    width: 275px;
    background: #383838;
    border-right: 1px solid #555;
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    overflow-y: auto;
  }
  .sidebar::-webkit-scrollbar { width:4px; }
  .sidebar::-webkit-scrollbar-thumb { background:#555; border-radius:2px; }

  .sb-section { padding:14px; border-bottom:1px solid #444; }

  .sb-titulo {
    color: #ffb800;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    border-bottom: 1px solid #ffb800;
    padding-bottom: 6px;
    margin-bottom: 12px;
  }

  .campo-sb { margin-bottom:10px; }

  .btn-full {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    font-weight: 700;
    font-size: 12px;
    cursor: pointer;
    letter-spacing: 1px;
    text-transform: uppercase;
    transition: 0.2s;
    font-family: 'Segoe UI', sans-serif;
    border: none;
    margin-top: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  .btn-full:hover { filter:brightness(1.15); }
  .bf-amarillo { background:#ffb800; color:black; }
  .bf-gris { background:#555; color:#aaa; margin-top:6px; }

  /* Piezas */
  .pieza-item {
    display:flex; align-items:flex-start; gap:8px;
    padding:7px 8px; border-radius:6px; cursor:pointer;
    transition:background 0.15s; border:1px solid transparent;
  }
  .pieza-item:hover { background:#444; }
  .pieza-item.activa { background:#444; border-color:#ffb800; }
  .pieza-dot { width:10px; height:10px; border-radius:2px; flex-shrink:0; margin-top:3px; border:1px solid rgba(255,255,255,0.15); }
  .pieza-nombre { font-size:12px; color:white; font-weight:600; }
  .pieza-dim { font-size:10px; color:#aaa; margin-top:1px; }
  .canto-tag { display:inline-block; font-size:9px; padding:1px 5px; border-radius:3px; background:rgba(0,188,255,0.15); color:#00bcff; border:1px solid rgba(0,188,255,0.3); margin-right:2px; margin-top:2px; }

  /* Stats */
  .stat-fila { display:flex; justify-content:space-between; align-items:center; padding:5px 0; border-bottom:1px solid #444; font-size:11px; }
  .stat-lbl { color:#aaa; }
  .stat-val { color:white; font-weight:600; }
  .stat-val.am { color:#ffb800; }
  .stat-val.az { color:#00bcff; }

  /* Botones exportar */
  .btn-exp {
    width:100%; padding:9px; border-radius:8px; font-size:11px; font-weight:700;
    cursor:pointer; font-family:'Segoe UI',sans-serif; transition:0.2s; margin-bottom:6px;
    letter-spacing:1px; border:none; text-transform:uppercase;
    display:flex; align-items:center; gap:8px;
  }
  .btn-exp:hover { filter:brightness(1.2); transform:translateY(-1px); }
  .exp-pdf { background:#ffb800; color:black; }
  .exp-dxf { background:#1A5276; color:white; }
  .exp-2d  { background:#218838; color:white; }

  .empty-msg { text-align:center; color:#555; font-size:11px; padding:16px 0; letter-spacing:1px; text-transform:uppercase; }

  /* CANVAS AREA */
  .canvas-area { flex:1; display:flex; flex-direction:column; overflow:hidden; }

  /* Tabs */
  .tabs { display:flex; background:#1e1e1e; border-bottom:1px solid #555; padding:0 16px; flex-shrink:0; }
  .tab { padding:10px 18px; font-size:12px; font-weight:700; color:#aaa; cursor:pointer; border-bottom:2px solid transparent; transition:0.2s; letter-spacing:1px; text-transform:uppercase; }
  .tab:hover { color:white; }
  .tab.activo { color:#ffb800; border-bottom-color:#ffb800; }

  /* 3D */
  .canvas-cont { flex:1; position:relative; overflow:hidden; background:#1a1a1a; }
  #renderCanvas { width:100%; height:100%; display:block; touch-action:none; outline:none; }

  .vista-lbl { position:absolute; top:10px; left:10px; background:rgba(30,30,30,0.9); border:1px solid #555; border-radius:6px; padding:5px 12px; font-size:11px; color:#aaa; letter-spacing:1px; text-transform:uppercase; }
  .vista-lbl span { color:#ffb800; font-weight:700; }

  .ctrl-overlay { position:absolute; bottom:16px; right:16px; display:flex; flex-direction:column; gap:5px; }
  .ctrl-btn { width:36px; height:36px; background:rgba(56,56,56,0.92); border:1px solid #555; border-radius:6px; color:#ffb800; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:13px; transition:0.15s; }
  .ctrl-btn:hover { background:#ffb800; color:black; border-color:#ffb800; }

  /* 2D Panel */
  #panel2d { flex:1; background:#2c2c2c; display:none; overflow:auto; padding:20px; }
  #panel2d.visible { display:flex; flex-direction:column; align-items:center; }
  .plano-wrap { background:#383838; border-radius:12px; border:1px solid #555; padding:24px; width:100%; max-width:900px; }
  .plano-titulo { color:#ffb800; font-size:16px; font-weight:700; letter-spacing:2px; text-transform:uppercase; border-bottom:2px solid #ffb800; padding-bottom:8px; margin-bottom:16px; }
  .vistas-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
  .vista-box { border:1px solid #555; border-radius:8px; padding:12px; background:#2c2c2c; }
  .vista-box-titulo { font-size:10px; font-weight:700; letter-spacing:2px; text-transform:uppercase; color:#aaa; margin-bottom:8px; }
  .vista-svg-wrap { width:100%; aspect-ratio:4/3; background:#1e1e1e; border:1px solid #444; border-radius:4px; overflow:hidden; }

  /* Despiece Panel */
  #panelDespiece { flex:1; background:#2c2c2c; display:none; overflow:auto; padding:20px; }
  #panelDespiece.visible { display:block; }
  .desp-wrap { background:#383838; border-radius:12px; border:1px solid #555; padding:24px; max-width:1000px; margin:0 auto; }
  .desp-hdr { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:16px; padding-bottom:12px; border-bottom:2px solid #ffb800; }
  .desp-titulo { color:#ffb800; font-size:18px; font-weight:700; letter-spacing:2px; text-transform:uppercase; }
  .desp-meta { font-size:11px; color:#aaa; margin-top:3px; }
  .desp-logo { color:#ffb800; font-weight:700; font-size:12px; text-align:right; letter-spacing:1px; text-transform:uppercase; }

  .tabla-cont { border-radius:8px; overflow:hidden; border:1px solid #555; margin-top:10px; }
  table { width:100%; border-collapse:collapse; background:#383838; }
  thead { background:#ffb800; color:black; }
  th { padding:11px 13px; font-size:11px; text-transform:uppercase; letter-spacing:1px; text-align:left; font-family:'Segoe UI',sans-serif; }
  td { padding:9px 13px; border-bottom:1px solid #444; font-size:12px; }
  tbody tr:hover { background:#444; }

  .resumen-cantos { margin-top:16px; padding:14px; background:#2c2c2c; border-radius:8px; border-left:3px solid #ffb800; }
  .resumen-titulo { font-size:11px; font-weight:700; color:#ffb800; letter-spacing:1px; text-transform:uppercase; margin-bottom:10px; }
  .resumen-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:8px; }
  .resumen-item { background:#383838; border-radius:6px; padding:10px 14px; border:1px solid #555; }
  .res-mat { font-size:10px; color:#aaa; margin-bottom:2px; text-transform:uppercase; }
  .res-metros { font-size:22px; font-weight:700; color:#ffb800; }
  .res-unit { font-size:11px; color:#aaa; }

  /* Loading */
  #loading { position:fixed; inset:0; background:#2c2c2c; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999; transition:opacity 0.5s; }
  #loading.oculto { opacity:0; pointer-events:none; }
  .ld-titulo { color:#ffb800; font-size:22px; font-weight:700; letter-spacing:3px; text-transform:uppercase; margin-bottom:6px; }
  .ld-sub { font-size:11px; color:#aaa; margin-bottom:28px; letter-spacing:2px; text-transform:uppercase; }
  .ld-bar { width:220px; height:3px; background:#444; border-radius:2px; overflow:hidden; }
  .ld-fill { height:100%; background:#ffb800; border-radius:2px; animation:ldFill 2s ease forwards; }
  @keyframes ldFill { from{width:0} to{width:100%} }

  /* Toast */
  .toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(16px); background:#383838; border:1px solid #ffb800; color:white; padding:10px 22px; border-radius:8px; font-size:12px; font-weight:600; opacity:0; transition:all 0.3s; z-index:9999; pointer-events:none; }
  .toast.visible { opacity:1; transform:translateX(-50%) translateY(0); }
</style>
</head>
<body>

<div id="loading">
  <div class="ld-titulo">HG Interiores de Madera</div>
  <div class="ld-sub">Visor 3D Â· Planos Â· Despiece</div>
  <div class="ld-bar"><div class="ld-fill"></div></div>
</div>

<header>
  <div class="hdr-titulo"><i class="fas fa-cube"></i> HG Interiores de Madera â€” Visor 3D</div>
  <div class="hdr-right">
    <div class="badge-proyecto" id="badgeProyecto">Sin proyecto cargado</div>
    <button class="btn-hg btn-amarillo" onclick="volverApp()"><i class="fas fa-home"></i> Volver a la app</button>
  </div>
</header>

<div class="main">

  <!-- SIDEBAR -->
  <div class="sidebar">

    <div class="sb-section">
      <div class="sb-titulo"><i class="fas fa-folder-open"></i> Proyecto</div>
      <div class="campo-sb">
        <label>Cliente</label>
        <select id="selCliente" onchange="onCambiaCliente()">
          <option value="">Seleccionar...</option>
        </select>
      </div>
      <div class="campo-sb">
        <label>Localidad</label>
        <input type="text" id="inputLocalidad" readonly placeholder="â€”">
      </div>
      <div class="campo-sb">
        <label>Proyecto</label>
        <input type="text" id="inputProyecto" placeholder="Nombre proyecto..." list="listaProyectos">
        <datalist id="listaProyectos"></datalist>
      </div>
      <button class="btn-full bf-amarillo" onclick="cargarProyecto()"><i class="fas fa-sync-alt"></i> Cargar proyecto 3D</button>
      <button class="btn-full bf-gris" onclick="cargarEjemplo()"><i class="fas fa-dice"></i> Ver ejemplo</button>
    </div>

    <div class="sb-section" style="flex:1">
      <div class="sb-titulo"><i class="fas fa-th-list"></i> Piezas</div>
      <div id="listaPiezas"><div class="empty-msg">Sin piezas cargadas</div></div>
    </div>

    <div class="sb-section">
      <div class="sb-titulo"><i class="fas fa-chart-bar"></i> Resumen</div>
      <div class="stat-fila"><span class="stat-lbl">Total piezas</span><span class="stat-val am" id="statPiezas">0</span></div>
      <div class="stat-fila"><span class="stat-lbl">Materiales</span><span class="stat-val" id="statMateriales">â€”</span></div>
      <div class="stat-fila"><span class="stat-lbl">Canto total</span><span class="stat-val az" id="statCanto">0.00 m</span></div>
    </div>

    <div class="sb-section">
      <div class="sb-titulo"><i class="fas fa-download"></i> Exportar</div>
      <button class="btn-exp exp-pdf" onclick="exportarPDF()"><i class="fas fa-print"></i> Despiece PDF</button>
      <button class="btn-exp exp-dxf" onclick="exportarDXF()"><i class="fas fa-drafting-compass"></i> Planos DXF</button>
      <button class="btn-exp exp-2d"  onclick="switchTab('2d')"><i class="fas fa-ruler-combined"></i> Ver planos 2D</button>
    </div>

  </div>

  <!-- CANVAS AREA -->
  <div class="canvas-area">

    <div class="tabs">
      <div class="tab activo" id="tab3d" onclick="switchTab('3d')"><i class="fas fa-cube"></i> Vista 3D</div>
      <div class="tab" id="tab2d" onclick="switchTab('2d')"><i class="fas fa-ruler-combined"></i> Planos 2D</div>
      <div class="tab" id="tabDesp" onclick="switchTab('despiece')"><i class="fas fa-list-alt"></i> Despiece</div>
    </div>

    <div class="canvas-cont" id="cont3d">
      <canvas id="renderCanvas"></canvas>
      <div class="vista-lbl">Vista: <span id="vistaActual">Perspectiva</span></div>
      <div class="ctrl-overlay">
        <button class="ctrl-btn" onclick="setVista('perspectiva')" title="Perspectiva">â¬›</button>
        <button class="ctrl-btn" onclick="setVista('frente')" title="Alzado">â¬†</button>
        <button class="ctrl-btn" onclick="setVista('lateral')" title="Lateral">âž¡</button>
        <button class="ctrl-btn" onclick="setVista('planta')" title="Planta">ðŸ”½</button>
        <button class="ctrl-btn" onclick="centrarCamara()" title="Centrar">ðŸŽ¯</button>
      </div>
    </div>

    <div id="panel2d">
      <div class="plano-wrap">
        <div class="plano-titulo"><i class="fas fa-ruler-combined"></i> Planos TÃ©cnicos 2D</div>
        <div class="vistas-grid">
          <div class="vista-box">
            <div class="vista-box-titulo">Alzado (Frente)</div>
            <div class="vista-svg-wrap"><svg id="svgAlzado" width="100%" height="100%"></svg></div>
          </div>
          <div class="vista-box">
            <div class="vista-box-titulo">Planta (Superior)</div>
            <div class="vista-svg-wrap"><svg id="svgPlanta" width="100%" height="100%"></svg></div>
          </div>
          <div class="vista-box">
            <div class="vista-box-titulo">Perfil (Lateral)</div>
            <div class="vista-svg-wrap"><svg id="svgPerfil" width="100%" height="100%"></svg></div>
          </div>
          <div class="vista-box">
            <div class="vista-box-titulo">InformaciÃ³n del proyecto</div>
            <div id="infoPlano" style="font-size:12px;color:#aaa;padding:6px;line-height:2;">Carga un proyecto.</div>
          </div>
        </div>
      </div>
    </div>

    <div id="panelDespiece">
      <div class="desp-wrap">
        <div class="desp-hdr">
          <div>
            <div class="desp-titulo"><i class="fas fa-list-alt"></i> Listado de Despiece</div>
            <div class="desp-meta" id="despMeta">â€” Sin proyecto cargado â€”</div>
          </div>
          <div class="desp-logo">HG Interiores<br>de Madera</div>
        </div>
        <div class="tabla-cont">
          <table>
            <thead>
              <tr>
                <th>#</th><th>Pieza</th><th>Largo</th><th>Ancho</th><th>Grueso</th>
                <th>Material</th><th>L.Canto</th><th>A.Canto</th><th>Color Canto</th><th>M.L. Canto</th>
              </tr>
            </thead>
            <tbody id="despTbody">
              <tr><td colspan="10" style="text-align:center;color:#555;padding:20px;">Sin datos</td></tr>
            </tbody>
          </table>
        </div>
        <div class="resumen-cantos" id="resumenCantos" style="display:none">
          <div class="resumen-titulo"><i class="fas fa-ruler"></i> Metros lineales de canto por material</div>
          <div class="resumen-grid" id="resumenGrid"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ===== CONSTANTES =====
const DEMASIA = 70;
const SHEET_ID = '1IWL_c9qRLY5Zm8jZwu1Ybh29Fs3jvHec6uHaAFahmk0';
const URL_APP = 'https://script.google.com/macros/s/AKfycbwQxs7hRGXhKYLgpR32TR--Xe66hgjo6xFO5jd18mdHcy_3YMAV3QLVUCanAVjNTcxO/exec?p=Index';

// ===== ESTADO =====
let engine, scene, camera;
let piezas = [], meshes = [];
let proyecto = { cliente:'', localidad:'', nombre:'', fecha:'' };
let clientesData = [];

// ===== INIT =====
window.addEventListener('DOMContentLoaded', () => {
  const canvas = document.getElementById('renderCanvas');
  engine = new BABYLON.Engine(canvas, true);
  scene = crearEscena(engine, canvas);
  engine.runRenderLoop(() => scene && scene.render());
  window.addEventListener('resize', () => engine.resize());

  // Leer params de URL si vienen de Apps Script
  const params = new URLSearchParams(window.location.search);
  if (params.get('cli')) document.getElementById('selCliente').value = params.get('cli');
  if (params.get('proy')) document.getElementById('inputProyecto').value = params.get('proy');

  cargarClientesDesdeSheets();
  setTimeout(() => document.getElementById('loading').classList.add('oculto'), 2200);
});

// ===== ESCENA =====
function crearEscena(engine, canvas) {
  const sc = new BABYLON.Scene(engine);
  sc.clearColor = new BABYLON.Color4(0.1,0.1,0.1,1);

  camera = new BABYLON.ArcRotateCamera('cam',-Math.PI/4,Math.PI/3.5,25,BABYLON.Vector3.Zero(),sc);
  camera.attachControl(canvas,true);
  camera.lowerRadiusLimit=2; camera.upperRadiusLimit=300; camera.wheelDeltaPercentage=0.01;

  const h = new BABYLON.HemisphericLight('h',new BABYLON.Vector3(0,1,0),sc); h.intensity=0.75;
  const d = new BABYLON.DirectionalLight('d',new BABYLON.Vector3(-1,-2,-1),sc); d.intensity=0.6; d.position=new BABYLON.Vector3(20,40,20);

  const suelo = BABYLON.MeshBuilder.CreateGround('s',{width:200,height:200},sc);
  const sm = new BABYLON.StandardMaterial('sm',sc);
  sm.diffuseColor=new BABYLON.Color3(0.12,0.12,0.12); sm.specularColor=new BABYLON.Color3(0,0,0);
  suelo.material=sm;

  for (let i=-100;i<=100;i+=5) {
    const a = BABYLON.MeshBuilder.CreateLines('a'+i,{points:[new BABYLON.Vector3(-100,0.01,i),new BABYLON.Vector3(100,0.01,i)]},sc);
    a.color=new BABYLON.Color3(0.2,0.2,0.2);
    const b = BABYLON.MeshBuilder.CreateLines('b'+i,{points:[new BABYLON.Vector3(i,0.01,-100),new BABYLON.Vector3(i,0.01,100)]},sc);
    b.color=new BABYLON.Color3(0.2,0.2,0.2);
  }
  return sc;
}

// ===== COLORES =====
const COLORES = {'blanco':'#F0F0EC','blanco brillo':'#FFFFFF','blanco mate':'#E8E8E4','negro':'#1A1A1A','negro mate':'#222','roble':'#8B6914','nogal':'#5C3D11','haya':'#C4956A','gris':'#9E9E9E','gris claro':'#D4D4D4','gris oscuro':'#616161','azul':'#1565C0','verde':'#2E7D32','rojo':'#C62828','antracita':'#37474F','aluminio':'#90A4AE','natural':'#A0784A','pino':'#D4A76A','cerezo':'#8B2500','wengue':'#3D2314'};

function colorMat(mat) {
  if (!mat) return '#AAAAAA';
  const k = mat.toLowerCase().trim();
  for (const [n,h] of Object.entries(COLORES)) if (k.includes(n)) return h;
  return '#BBBBAA';
}
function hex3(hex) { return new BABYLON.Color3(parseInt(hex.slice(1,3),16)/255,parseInt(hex.slice(3,5),16)/255,parseInt(hex.slice(5,7),16)/255); }

// ===== CANTO =====
// L1=1 pasada largo+70 | L2=2 pasadas largo+140 | A1=1 pasada ancho+70 | A2=2 pasadas ancho+140
function mmCanto(p) {
  const lg=parseFloat(p.ALTO)||0, an=parseFloat(p.ANCHO)||0;
  const lc=(p['LARGO.CANTO']||'').toUpperCase().trim();
  const ac=(p['ANCHO.CANTO']||'').toUpperCase().trim();
  let t=0;
  if(lc==='L1') t+=lg+DEMASIA;
  if(lc==='L2') t+=(lg*2)+(DEMASIA*2);
  if(ac==='A1') t+=an+DEMASIA;
  if(ac==='A2') t+=(an*2)+(DEMASIA*2);
  return t;
}

// ===== CLIENTES DESDE SHEETS =====
async function cargarClientesDesdeSheets() {
  try {
    const url = `${URL_APP}&action=getClientes&sheetId=${SHEET_ID}`;
    const r = await fetch(url);
    const d = await r.json();
    clientesData = d.clientes || [];
    const sel = document.getElementById('selCliente');
    clientesData.forEach(c => sel.add(new Option(c.CLIENTE, c.CLIENTE)));
  } catch(e) {
    console.log('Sin conexiÃ³n a clientes, modo manual activo');
  }
}

function onCambiaCliente() {
  const cli = document.getElementById('selCliente').value;
  const found = clientesData.find(c=>c.CLIENTE===cli);
  document.getElementById('inputLocalidad').value = found ? (found.LOCALIDAD||'') : '';
  document.getElementById('inputProyecto').value = '';
  if (cli) cargarProyectosCliente(cli);
}

async function cargarProyectosCliente(cli) {
  try {
    const url = `${URL_APP}&action=getProyectos3D&cliente=${encodeURIComponent(cli)}&sheetId=${SHEET_ID}`;
    const r = await fetch(url);
    const d = await r.json();
    const lista = document.getElementById('listaProyectos');
    lista.innerHTML = '';
    (d.proyectos||[]).forEach(p => lista.innerHTML+=`<option value="${p}">`);
  } catch(e) {}
}

// ===== CARGAR PROYECTO =====
async function cargarProyecto() {
  const cli = document.getElementById('selCliente').value;
  const proy = document.getElementById('inputProyecto').value.trim();
  if (!cli||!proy) { showToast('âš  Selecciona cliente y proyecto'); return; }
  showToast('â³ Cargando piezas...');
  try {
    const url = `${URL_APP}&action=getMuebles3D&cliente=${encodeURIComponent(cli)}&proyecto=${encodeURIComponent(proy)}&sheetId=${SHEET_ID}`;
    const r = await fetch(url);
    const d = await r.json();
    if (d&&d.piezas&&d.piezas.length) {
      cargarDatos(d.piezas, cli, document.getElementById('inputLocalidad').value, proy);
    } else {
      showToast('âš  Sin piezas 3D para ese proyecto. Prueba "Ver ejemplo".');
    }
  } catch(e) {
    showToast('âš  Error de conexiÃ³n. Usa "Ver ejemplo" para probar.');
  }
}

function cargarEjemplo() {
  const ej = [
    {PIEZA:'Costado izquierdo', ALTO:2100,ANCHO:600, GRUESO:18, X:0,  Y:0,   Z:0,   MATERIAL:'Blanco mate',  'COLOR.CANTO':'Blanco','LARGO.CANTO':'L2','ANCHO.CANTO':'A1'},
    {PIEZA:'Costado derecho',   ALTO:2100,ANCHO:600, GRUESO:18, X:582,Y:0,   Z:0,   MATERIAL:'Blanco mate',  'COLOR.CANTO':'Blanco','LARGO.CANTO':'L2','ANCHO.CANTO':'A1'},
    {PIEZA:'Techo',             ALTO:564, ANCHO:18,  GRUESO:600,X:18, Y:2082,Z:0,   MATERIAL:'Blanco mate',  'COLOR.CANTO':'Blanco','LARGO.CANTO':'L2','ANCHO.CANTO':''},
    {PIEZA:'Suelo',             ALTO:564, ANCHO:18,  GRUESO:600,X:18, Y:0,   Z:0,   MATERIAL:'Blanco mate',  'COLOR.CANTO':'Blanco','LARGO.CANTO':'L2','ANCHO.CANTO':''},
    {PIEZA:'Balda',             ALTO:564, ANCHO:18,  GRUESO:580,X:18, Y:1050,Z:10,  MATERIAL:'Blanco mate',  'COLOR.CANTO':'Blanco','LARGO.CANTO':'L2','ANCHO.CANTO':''},
    {PIEZA:'Respaldo',          ALTO:2064,ANCHO:564, GRUESO:8,  X:18, Y:18,  Z:592, MATERIAL:'Blanco mate',  'COLOR.CANTO':'',      'LARGO.CANTO':'', 'ANCHO.CANTO':''},
    {PIEZA:'Puerta izquierda',  ALTO:2100,ANCHO:300, GRUESO:18, X:0,  Y:0,   Z:-20, MATERIAL:'Blanco brillo','COLOR.CANTO':'Blanco','LARGO.CANTO':'L2','ANCHO.CANTO':'A2'},
    {PIEZA:'Puerta derecha',    ALTO:2100,ANCHO:300, GRUESO:18, X:300,Y:0,   Z:-20, MATERIAL:'Blanco brillo','COLOR.CANTO':'Blanco','LARGO.CANTO':'L2','ANCHO.CANTO':'A2'},
  ];
  cargarDatos(ej,'Cliente Ejemplo','Madrid','Armario Dormitorio');
}

function cargarDatos(data,cli,loc,proy) {
  piezas=data;
  proyecto={cliente:cli,localidad:loc,nombre:proy,fecha:new Date().toLocaleDateString('es-ES')};
  document.getElementById('badgeProyecto').textContent=`${cli} â€” ${proy}`;
  dibujar3D(data);
  renderLista(data);
  actualizarStats(data);
  generarDespiece(data);
  generarPlanos2D(data);
  showToast(`âœ… ${data.length} piezas cargadas`);
}

// ===== 3D =====
function dibujar3D(data) {
  meshes.forEach(m=>m.dispose()); meshes=[];
  const E=0.01;
  data.forEach((p,i)=>{
    const an=(parseFloat(p.ANCHO)||100)*E, al=(parseFloat(p.ALTO)||100)*E, gr=(parseFloat(p.GRUESO)||18)*E;
    const x=(parseFloat(p.X)||0)*E, y=(parseFloat(p.Y)||0)*E, z=(parseFloat(p.Z)||0)*E;
    const box=BABYLON.MeshBuilder.CreateBox(`p${i}`,{width:an,height:al,depth:gr},scene);
    box.position=new BABYLON.Vector3(x+an/2,y+al/2,z+gr/2);
    const mat=new BABYLON.StandardMaterial(`m${i}`,scene);
    mat.diffuseColor=hex3(colorMat(p.MATERIAL));
    mat.specularColor=new BABYLON.Color3(0.05,0.05,0.05);
    box.material=mat;
    box.enableEdgesRendering(); box.edgesWidth=1.5; box.edgesColor=new BABYLON.Color4(0.15,0.15,0.15,0.6);
    box.actionManager=new BABYLON.ActionManager(scene);
    box.actionManager.registerAction(new BABYLON.ExecuteCodeAction(BABYLON.ActionManager.OnPickTrigger,()=>selPieza(i)));
    meshes.push(box);
  });
  centrarCamara();
}

function selPieza(idx) {
  meshes.forEach((m,i)=>{
    m.edgesColor=i===idx?new BABYLON.Color4(1,0.72,0,1):new BABYLON.Color4(0.15,0.15,0.15,0.6);
    m.edgesWidth=i===idx?3.5:1.5;
  });
  document.querySelectorAll('.pieza-item').forEach((el,i)=>el.classList.toggle('activa',i===idx));
}

// ===== CÃMARA =====
function setVista(tipo) {
  const v={perspectiva:{a:-Math.PI/4,b:Math.PI/3.5,r:25,l:'Perspectiva'},frente:{a:Math.PI,b:Math.PI/2,r:30,l:'Alzado'},lateral:{a:Math.PI/2,b:Math.PI/2,r:30,l:'Perfil'},planta:{a:0,b:0.01,r:30,l:'Planta'}};
  const c=v[tipo]||v.perspectiva;
  camera.alpha=c.a; camera.beta=c.b; camera.radius=c.r;
  document.getElementById('vistaActual').textContent=c.l;
}
function centrarCamara() {
  if(!meshes.length) return;
  let cx=0,cy=0,cz=0;
  meshes.forEach(m=>{cx+=m.position.x;cy+=m.position.y;cz+=m.position.z;});
  camera.target=new BABYLON.Vector3(cx/meshes.length,cy/meshes.length/2,cz/meshes.length);
}

// ===== LISTA PIEZAS =====
function renderLista(data) {
  const c=document.getElementById('listaPiezas'); c.innerHTML='';
  data.forEach((p,i)=>{
    const lc=p['LARGO.CANTO']||'', ac=p['ANCHO.CANTO']||'';
    const div=document.createElement('div'); div.className='pieza-item';
    div.innerHTML=`
      <div class="pieza-dot" style="background:${colorMat(p.MATERIAL)}"></div>
      <div style="flex:1;min-width:0">
        <div class="pieza-nombre">${p.PIEZA||`Pieza ${i+1}`}</div>
        <div class="pieza-dim">${p.ALTO}Ã—${p.ANCHO}Ã—${p.GRUESO} mm Â· ${p.MATERIAL||'â€”'}</div>
        <div>
          ${lc?`<span class="canto-tag">${lc}</span>`:''}
          ${ac?`<span class="canto-tag">${ac}</span>`:''}
        </div>
      </div>`;
    div.onclick=()=>selPieza(i); c.appendChild(div);
  });
}

// ===== STATS =====
function actualizarStats(data) {
  document.getElementById('statPiezas').textContent=data.length;
  const mats=[...new Set(data.map(p=>p.MATERIAL).filter(Boolean))];
  document.getElementById('statMateriales').textContent=mats.length?mats.slice(0,2).join(', ')+(mats.length>2?'...':''):'â€”';
  const total=data.reduce((a,p)=>a+mmCanto(p),0);
  document.getElementById('statCanto').textContent=(total/1000).toFixed(2)+' m';
}

// ===== DESPIECE =====
function generarDespiece(data) {
  const tb=document.getElementById('despTbody');
  document.getElementById('despMeta').textContent=`${proyecto.cliente} â€” ${proyecto.nombre} â€” ${proyecto.localidad} â€” ${proyecto.fecha}`;
  tb.innerHTML='';
  data.forEach((p,i)=>{
    const mm=mmCanto(p);
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${i+1}</td>
      <td><b>${p.PIEZA||`Pieza ${i+1}`}</b></td>
      <td>${p.ALTO}</td><td>${p.ANCHO}</td><td>${p.GRUESO}</td>
      <td>${p.MATERIAL||'â€”'}</td>
      <td style="color:#00bcff;font-weight:700">${p['LARGO.CANTO']||'â€”'}</td>
      <td style="color:#00bcff;font-weight:700">${p['ANCHO.CANTO']||'â€”'}</td>
      <td>${p['COLOR.CANTO']||'â€”'}</td>
      <td style="color:#ffb800;font-weight:700">${(mm/1000).toFixed(3)} m</td>`;
    tb.appendChild(tr);
  });

  const pm={};
  data.forEach(p=>{
    const m=p['COLOR.CANTO']||p.MATERIAL||'Sin especificar';
    if(!pm[m]) pm[m]=0; pm[m]+=mmCanto(p);
  });
  const grid=document.getElementById('resumenGrid'); grid.innerHTML='';
  Object.entries(pm).forEach(([m,mm])=>{
    if(mm<=0) return;
    const d=document.createElement('div'); d.className='resumen-item';
    d.innerHTML=`<div class="res-mat">${m}</div><div class="res-metros">${(mm/1000).toFixed(2)}<span class="res-unit"> m</span></div>`;
    grid.appendChild(d);
  });
  document.getElementById('resumenCantos').style.display='block';
}

// ===== PLANOS 2D =====
function generarPlanos2D(data) {
  if(!data.length) return;
  document.getElementById('infoPlano').innerHTML=`
    <b style="color:#ffb800">Cliente:</b> ${proyecto.cliente}<br>
    <b style="color:#ffb800">Localidad:</b> ${proyecto.localidad}<br>
    <b style="color:#ffb800">Proyecto:</b> ${proyecto.nombre}<br>
    <b style="color:#ffb800">Fecha:</b> ${proyecto.fecha}<br>
    <b style="color:#ffb800">Total piezas:</b> ${data.length}`;
  ['svgAlzado','svgPlanta','svgPerfil'].forEach((id,vi)=>dibujarSVG(id,data,['alzado','planta','perfil'][vi]));
}

function dibujarSVG(id,data,vista) {
  const svg=document.getElementById(id); svg.innerHTML='';
  const W=svg.clientWidth||320, H=svg.clientHeight||240, PAD=32;
  let mnX=Infinity,mxX=-Infinity,mnY=Infinity,mxY=-Infinity;
  data.forEach(p=>{
    const px=parseFloat(p.X)||0,py=parseFloat(p.Y)||0,pz=parseFloat(p.Z)||0;
    const pw=parseFloat(p.ANCHO)||0,ph=parseFloat(p.ALTO)||0,pd=parseFloat(p.GRUESO)||0;
    let x1,x2,y1,y2;
    if(vista==='alzado'){x1=px;x2=px+pw;y1=py;y2=py+ph;}
    else if(vista==='planta'){x1=px;x2=px+pw;y1=pz;y2=pz+pd;}
    else{x1=pz;x2=pz+pd;y1=py;y2=py+ph;}
    mnX=Math.min(mnX,x1);mxX=Math.max(mxX,x2);mnY=Math.min(mnY,y1);mxY=Math.max(mxY,y2);
  });
  const rX=mxX-mnX||1,rY=mxY-mnY||1;
  const sc=Math.min((W-PAD*2)/rX,(H-PAD*2)/rY);
  const oX=PAD+(W-PAD*2-rX*sc)/2-mnX*sc, oY=PAD+(H-PAD*2-rY*sc)/2-mnY*sc;
  const ns='http://www.w3.org/2000/svg';
  const bg=document.createElementNS(ns,'rect'); bg.setAttribute('width',W); bg.setAttribute('height',H); bg.setAttribute('fill','#1e1e1e'); svg.appendChild(bg);
  data.forEach(p=>{
    const px=parseFloat(p.X)||0,py=parseFloat(p.Y)||0,pz=parseFloat(p.Z)||0;
    const pw=parseFloat(p.ANCHO)||0,ph=parseFloat(p.ALTO)||0,pd=parseFloat(p.GRUESO)||0;
    let rx,ry,rw,rh;
    if(vista==='alzado'){rx=px;ry=mxY-(py+ph);rw=pw;rh=ph;}
    else if(vista==='planta'){rx=px;ry=pz;rw=pw;rh=pd;}
    else{rx=pz;ry=mxY-(py+ph);rw=pd;rh=ph;}
    const r=document.createElementNS(ns,'rect');
    r.setAttribute('x',rx*sc+oX); r.setAttribute('y',ry*sc+oY);
    r.setAttribute('width',Math.max(rw*sc,1)); r.setAttribute('height',Math.max(rh*sc,1));
    r.setAttribute('fill',colorMat(p.MATERIAL)); r.setAttribute('fill-opacity','0.85');
    r.setAttribute('stroke','#ffb800'); r.setAttribute('stroke-width','0.8');
    svg.appendChild(r);
  });
  // Cotas
  const addL=(x1,y1,x2,y2)=>{const l=document.createElementNS(ns,'line');l.setAttribute('x1',x1);l.setAttribute('y1',y1);l.setAttribute('x2',x2);l.setAttribute('y2',y2);l.setAttribute('stroke','#ffb800');l.setAttribute('stroke-width','0.8');svg.appendChild(l);};
  const addT=(x,y,txt,rot)=>{const t=document.createElementNS(ns,'text');t.setAttribute('fill','#ffb800');t.setAttribute('font-size','8');t.setAttribute('font-family','Segoe UI,sans-serif');t.setAttribute('font-weight','700');t.setAttribute('text-anchor','middle');if(rot)t.setAttribute('transform',`rotate(-90,${x},${y})`);t.setAttribute('x',x);t.setAttribute('y',y);t.textContent=txt;svg.appendChild(t);};
  addL(PAD,H-10,W-PAD,H-10); addT((PAD+W-PAD)/2,H-3,`${Math.round(rX)} mm`,false);
  addL(10,PAD,10,H-PAD); addT(10,(PAD+H-PAD)/2,`${Math.round(rY)} mm`,true);
}

// ===== TABS =====
function switchTab(tab) {
  document.getElementById('cont3d').style.display='none';
  document.getElementById('panel2d').classList.remove('visible');
  document.getElementById('panelDespiece').classList.remove('visible');
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('activo'));
  if(tab==='3d'){document.getElementById('cont3d').style.display='block';document.getElementById('tab3d').classList.add('activo');engine.resize();}
  else if(tab==='2d'){document.getElementById('panel2d').classList.add('visible');document.getElementById('tab2d').classList.add('activo');if(piezas.length)generarPlanos2D(piezas);}
  else{document.getElementById('panelDespiece').classList.add('visible');document.getElementById('tabDesp').classList.add('activo');}
}

// ===== EXPORTAR =====
function exportarPDF() {
  if(!piezas.length){showToast('âš  Carga un proyecto primero');return;}
  switchTab('despiece'); setTimeout(()=>window.print(),300);
}

function exportarDXF() {
  if(!piezas.length){showToast('âš  Carga un proyecto primero');return;}
  let dxf='0\nSECTION\n2\nHEADER\n0\nENDSEC\n0\nSECTION\n2\nENTITIES\n';
  piezas.forEach((p,i)=>{
    const x=parseFloat(p.X)||0,y=parseFloat(p.Y)||0,w=parseFloat(p.ANCHO)||0,h=parseFloat(p.ALTO)||0;
    dxf+=`0\nLWPOLYLINE\n8\nDESPIECE\n90\n4\n70\n1\n10\n${x}\n20\n${y}\n10\n${x+w}\n20\n${y}\n10\n${x+w}\n20\n${y+h}\n10\n${x}\n20\n${y+h}\n`;
    dxf+=`0\nTEXT\n8\nETIQUETAS\n10\n${x+5}\n20\n${y+h/2}\n40\n20\n1\n${p.PIEZA||i+1}\n`;
  });
  dxf+='0\nENDSEC\n0\nEOF';
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([dxf],{type:'text/plain'}));
  a.download=`${proyecto.nombre||'planos'}.dxf`; a.click();
  showToast('ðŸ“ DXF generado');
}

function volverApp() { window.location.href=URL_APP; }

function showToast(msg) {
  const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('visible');
  setTimeout(()=>t.classList.remove('visible'),3000);
}
</script>
</body>
</html>
