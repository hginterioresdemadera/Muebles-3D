<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HG Interiores de Madera ‚Äî Visor 3D</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babylonjs/6.26.0/babylon.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babylonjs-gui/6.26.0/babylon.gui.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap');

  :root {
    --madera: #8B5E3C;
    --madera-claro: #C4956A;
    --madera-oscuro: #5C3D1E;
    --crema: #F5EFE6;
    --crema-oscuro: #EAE0D0;
    --carbon: #1A1A1A;
    --gris: #6B6B6B;
    --gris-claro: #E8E2DA;
    --blanco: #FAFAF8;
    --acento: #C4956A;
    --exito: #4A7C59;
    --sidebar-w: 300px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--carbon);
    color: var(--crema);
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* ===== HEADER ===== */
  header {
    background: var(--madera-oscuro);
    border-bottom: 1px solid var(--madera);
    padding: 0 24px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
    z-index: 100;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo-icon {
    width: 32px; height: 32px;
    background: var(--madera-claro);
    border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
  }

  .logo-text {
    font-family: 'Playfair Display', serif;
    font-size: 16px;
    color: var(--crema);
    letter-spacing: 0.02em;
  }

  .logo-sub {
    font-size: 11px;
    color: var(--madera-claro);
    font-weight: 300;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }

  .header-info {
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .project-badge {
    background: rgba(196,149,106,0.15);
    border: 1px solid rgba(196,149,106,0.3);
    border-radius: 20px;
    padding: 4px 14px;
    font-size: 12px;
    color: var(--madera-claro);
  }

  .btn-volver {
    background: transparent;
    border: 1px solid var(--madera);
    color: var(--madera-claro);
    padding: 6px 16px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-block;
  }
  .btn-volver:hover { background: var(--madera); color: var(--crema); }

  /* ===== LAYOUT PRINCIPAL ===== */
  .main {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* ===== SIDEBAR ===== */
  .sidebar {
    width: var(--sidebar-w);
    background: #111111;
    border-right: 1px solid #2A2A2A;
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    overflow-y: auto;
  }

  .sidebar::-webkit-scrollbar { width: 4px; }
  .sidebar::-webkit-scrollbar-track { background: transparent; }
  .sidebar::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

  .sidebar-section {
    padding: 16px;
    border-bottom: 1px solid #2A2A2A;
  }

  .sidebar-title {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--madera-claro);
    margin-bottom: 12px;
  }

  /* Selector proyecto */
  .select-group { margin-bottom: 10px; }
  .select-label { font-size: 11px; color: var(--gris); margin-bottom: 4px; }
  
  select, input[type=text], input[type=number] {
    width: 100%;
    background: #1E1E1E;
    border: 1px solid #333;
    border-radius: 6px;
    color: var(--crema);
    padding: 7px 10px;
    font-size: 12px;
    font-family: 'DM Sans', sans-serif;
    outline: none;
    transition: border-color 0.2s;
  }
  select:focus, input:focus { border-color: var(--madera-claro); }
  select option { background: #1E1E1E; }

  .btn-cargar {
    width: 100%;
    background: var(--madera);
    color: var(--crema);
    border: none;
    border-radius: 6px;
    padding: 9px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: background 0.2s;
    margin-top: 8px;
    letter-spacing: 0.03em;
  }
  .btn-cargar:hover { background: var(--madera-claro); }

  /* Piezas list */
  .pieza-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 7px 8px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.15s;
    font-size: 11px;
  }
  .pieza-item:hover { background: #1E1E1E; }
  .pieza-item.active { background: rgba(196,149,106,0.15); }

  .pieza-color {
    width: 10px; height: 10px;
    border-radius: 2px;
    flex-shrink: 0;
  }

  .pieza-name { flex: 1; color: var(--crema-oscuro); }
  .pieza-dim { font-size: 10px; color: var(--gris); }

  /* Cantos badges */
  .cantos-row {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    margin-top: 2px;
  }
  .canto-badge {
    font-size: 9px;
    padding: 1px 5px;
    border-radius: 3px;
    background: rgba(196,149,106,0.2);
    color: var(--madera-claro);
    border: 1px solid rgba(196,149,106,0.3);
  }

  /* Stats */
  .stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    border-bottom: 1px solid #1E1E1E;
    font-size: 11px;
  }
  .stat-label { color: var(--gris); }
  .stat-value { color: var(--crema); font-weight: 500; }
  .stat-value.accent { color: var(--madera-claro); }

  /* Botones exportar */
  .btn-export {
    width: 100%;
    padding: 8px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.2s;
    margin-bottom: 6px;
    letter-spacing: 0.03em;
    border: none;
  }
  .btn-pdf { background: #C0392B; color: white; }
  .btn-pdf:hover { background: #E74C3C; }
  .btn-dxf { background: #1A5276; color: white; }
  .btn-dxf:hover { background: #2E86C1; }
  .btn-2d { background: #1E8449; color: white; }
  .btn-2d:hover { background: #27AE60; }

  /* ===== CANVAS AREA ===== */
  .canvas-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
  }

  /* Tabs */
  .tabs {
    display: flex;
    background: #0D0D0D;
    border-bottom: 1px solid #2A2A2A;
    padding: 0 16px;
    flex-shrink: 0;
  }

  .tab {
    padding: 10px 20px;
    font-size: 12px;
    color: var(--gris);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    font-weight: 500;
    letter-spacing: 0.02em;
  }
  .tab:hover { color: var(--crema-oscuro); }
  .tab.active { color: var(--madera-claro); border-bottom-color: var(--madera-claro); }

  /* Canvas 3D */
  #renderCanvas {
    width: 100%;
    height: 100%;
    display: block;
    touch-action: none;
  }

  .canvas-container {
    flex: 1;
    position: relative;
    overflow: hidden;
  }

  /* Controls overlay */
  .controls-overlay {
    position: absolute;
    bottom: 20px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .ctrl-btn {
    width: 36px; height: 36px;
    background: rgba(17,17,17,0.85);
    border: 1px solid #333;
    border-radius: 8px;
    color: var(--crema);
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px;
    transition: all 0.15s;
    backdrop-filter: blur(8px);
  }
  .ctrl-btn:hover { background: var(--madera); border-color: var(--madera); }

  /* Vista info */
  .vista-info {
    position: absolute;
    top: 12px;
    left: 12px;
    background: rgba(17,17,17,0.75);
    backdrop-filter: blur(8px);
    border: 1px solid #333;
    border-radius: 8px;
    padding: 8px 14px;
    font-size: 11px;
    color: var(--gris);
  }
  .vista-info span { color: var(--madera-claro); font-weight: 600; }

  /* ===== PANEL 2D ===== */
  #panel2d {
    flex: 1;
    background: #F8F6F2;
    display: none;
    overflow: auto;
    padding: 20px;
  }

  #panel2d.visible { display: flex; flex-direction: column; align-items: center; }

  .plano-container {
    background: white;
    border-radius: 8px;
    padding: 30px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.1);
    width: 100%;
    max-width: 900px;
  }

  .plano-title {
    font-family: 'Playfair Display', serif;
    font-size: 18px;
    color: var(--carbon);
    margin-bottom: 4px;
  }

  .plano-sub {
    font-size: 11px;
    color: var(--gris);
    margin-bottom: 20px;
    font-family: 'DM Sans', sans-serif;
  }

  .vistas-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: auto auto;
    gap: 20px;
  }

  .vista-box {
    border: 1px solid #DDD;
    border-radius: 6px;
    padding: 12px;
    background: #FAFAFA;
  }

  .vista-box-title {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--gris);
    margin-bottom: 8px;
    font-family: 'DM Sans', sans-serif;
  }

  .vista-svg-wrap {
    width: 100%;
    aspect-ratio: 4/3;
    background: white;
    border: 1px solid #EEE;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  /* ===== DESPIECE PANEL ===== */
  #panelDespiece {
    flex: 1;
    background: #F8F6F2;
    display: none;
    overflow: auto;
    padding: 20px;
  }

  #panelDespiece.visible { display: block; }

  .despiece-wrap {
    background: white;
    border-radius: 8px;
    padding: 30px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.1);
    max-width: 900px;
    margin: 0 auto;
  }

  .despiece-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 2px solid var(--madera);
  }

  .despiece-title { font-family: 'Playfair Display', serif; font-size: 20px; color: var(--carbon); }
  .despiece-meta { font-size: 11px; color: var(--gris); margin-top: 2px; }

  .despiece-logo { font-family: 'Playfair Display', serif; font-size: 14px; color: var(--madera); text-align: right; }

  table.despiece-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    font-family: 'DM Sans', sans-serif;
  }

  .despiece-table th {
    background: var(--madera-oscuro);
    color: white;
    padding: 8px 10px;
    text-align: left;
    font-weight: 600;
    font-size: 11px;
    letter-spacing: 0.05em;
  }

  .despiece-table td {
    padding: 7px 10px;
    border-bottom: 1px solid #EEE;
    color: var(--carbon);
  }

  .despiece-table tr:nth-child(even) td { background: #FAF8F5; }
  .despiece-table tr:hover td { background: #F0EBE3; }

  .canto-si { color: var(--exito); font-weight: 600; }
  .canto-no { color: #CCC; }

  .resumen-cantos {
    margin-top: 20px;
    padding: 16px;
    background: var(--crema);
    border-radius: 8px;
    border-left: 4px solid var(--madera);
  }

  .resumen-title { font-size: 13px; font-weight: 600; color: var(--carbon); margin-bottom: 10px; }

  .resumen-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 10px;
  }

  .resumen-item {
    background: white;
    border-radius: 6px;
    padding: 10px 14px;
    border: 1px solid var(--gris-claro);
  }

  .resumen-mat { font-size: 11px; color: var(--gris); margin-bottom: 2px; }
  .resumen-metros { font-size: 18px; font-weight: 700; color: var(--madera); }
  .resumen-unit { font-size: 11px; color: var(--gris); }

  /* ===== LOADING ===== */
  #loading {
    position: absolute;
    inset: 0;
    background: var(--carbon);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 50;
    transition: opacity 0.5s;
  }

  #loading.hidden { opacity: 0; pointer-events: none; }

  .loading-logo {
    font-family: 'Playfair Display', serif;
    font-size: 28px;
    color: var(--madera-claro);
    margin-bottom: 8px;
  }

  .loading-sub {
    font-size: 12px;
    color: var(--gris);
    margin-bottom: 30px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .loading-bar {
    width: 200px;
    height: 2px;
    background: #2A2A2A;
    border-radius: 1px;
    overflow: hidden;
  }

  .loading-fill {
    height: 100%;
    background: var(--madera-claro);
    border-radius: 1px;
    animation: loadFill 1.5s ease forwards;
  }

  @keyframes loadFill { from { width: 0; } to { width: 100%; } }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--carbon);
    border: 1px solid var(--madera);
    color: var(--crema);
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 12px;
    opacity: 0;
    transition: all 0.3s;
    z-index: 999;
    pointer-events: none;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--gris);
    font-size: 13px;
    gap: 8px;
  }
  .empty-icon { font-size: 48px; opacity: 0.3; }
</style>
</head>
<body>

<!-- Loading -->
<div id="loading">
  <div class="loading-logo">HG Interiores de Madera</div>
  <div class="loading-sub">Visor 3D ¬∑ Planos ¬∑ Despiece</div>
  <div class="loading-bar"><div class="loading-fill"></div></div>
</div>

<!-- Header -->
<header>
  <div class="logo">
    <div class="logo-icon">ü™µ</div>
    <div>
      <div class="logo-text">HG Interiores de Madera</div>
      <div class="logo-sub">Visor 3D Profesional</div>
    </div>
  </div>
  <div class="header-info">
    <div class="project-badge" id="projectBadge">Sin proyecto cargado</div>
    <a href="#" class="btn-volver" onclick="volverApps()">‚Üê Volver a la app</a>
  </div>
</header>

<!-- Main -->
<div class="main">

  <!-- Sidebar -->
  <div class="sidebar">

    <!-- Selector proyecto -->
    <div class="sidebar-section">
      <div class="sidebar-title">üìã Proyecto</div>
      <div class="select-group">
        <div class="select-label">ID Google Sheets</div>
        <input type="text" id="sheetId" placeholder="ID del Sheets..." value="">
      </div>
      <div class="select-group">
        <div class="select-label">Cliente</div>
        <input type="text" id="inputCliente" placeholder="Nombre cliente...">
      </div>
      <div class="select-group">
        <div class="select-label">Proyecto</div>
        <input type="text" id="inputProyecto" placeholder="Nombre proyecto...">
      </div>
      <button class="btn-cargar" onclick="cargarProyecto()">‚¨á Cargar proyecto</button>
      <button class="btn-cargar" style="background:#2A2A2A;margin-top:4px;" onclick="cargarEjemplo()">üé≤ Cargar ejemplo</button>
    </div>

    <!-- Piezas -->
    <div class="sidebar-section" style="flex:1">
      <div class="sidebar-title">ü™µ Piezas del proyecto</div>
      <div id="piezasList">
        <div class="empty-state" style="height:80px;font-size:11px;">
          <div>Sin piezas cargadas</div>
        </div>
      </div>
    </div>

    <!-- Estad√≠sticas -->
    <div class="sidebar-section">
      <div class="sidebar-title">üìä Resumen</div>
      <div class="stat-row">
        <span class="stat-label">Total piezas</span>
        <span class="stat-value accent" id="statPiezas">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Materiales</span>
        <span class="stat-value" id="statMateriales">‚Äî</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">Canto total</span>
        <span class="stat-value accent" id="statCanto">0.00 m</span>
      </div>
    </div>

    <!-- Exportar -->
    <div class="sidebar-section">
      <div class="sidebar-title">üì§ Exportar</div>
      <button class="btn-export btn-pdf" onclick="exportarPDF()">üìÑ Exportar despiece PDF</button>
      <button class="btn-export btn-dxf" onclick="exportarDXF()">üìê Exportar planos DXF</button>
      <button class="btn-export btn-2d" onclick="mostrar2D()">üìè Ver planos 2D</button>
    </div>

  </div>

  <!-- Canvas area -->
  <div class="canvas-area">

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" id="tab3d" onclick="switchTab('3d')">üßä Vista 3D</div>
      <div class="tab" id="tab2d" onclick="switchTab('2d')">üìê Planos 2D</div>
      <div class="tab" id="tabDespiece" onclick="switchTab('despiece')">üìã Despiece</div>
    </div>

    <!-- 3D Canvas -->
    <div class="canvas-container" id="container3d">
      <canvas id="renderCanvas"></canvas>
      <div class="vista-info">Vista: <span id="vistaActual">Perspectiva</span></div>
      <div class="controls-overlay">
        <button class="ctrl-btn" onclick="setVista('perspectiva')" title="Perspectiva">‚¨õ</button>
        <button class="ctrl-btn" onclick="setVista('frente')" title="Alzado">‚¨Ü</button>
        <button class="ctrl-btn" onclick="setVista('lateral')" title="Lateral">‚û°</button>
        <button class="ctrl-btn" onclick="setVista('planta')" title="Planta">üîΩ</button>
        <button class="ctrl-btn" onclick="centrarCamara()" title="Centrar">üéØ</button>
      </div>
    </div>

    <!-- 2D Panel -->
    <div id="panel2d">
      <div class="plano-container">
        <div class="plano-title">Planos T√©cnicos 2D</div>
        <div class="plano-sub" id="plano2dSub">‚Äî Sin proyecto cargado ‚Äî</div>
        <div class="vistas-grid">
          <div class="vista-box">
            <div class="vista-box-title">Alzado (Frente)</div>
            <div class="vista-svg-wrap"><svg id="svgAlzado" width="100%" height="100%"></svg></div>
          </div>
          <div class="vista-box">
            <div class="vista-box-title">Planta (Superior)</div>
            <div class="vista-svg-wrap"><svg id="svgPlanta" width="100%" height="100%"></svg></div>
          </div>
          <div class="vista-box">
            <div class="vista-box-title">Perfil (Lateral)</div>
            <div class="vista-svg-wrap"><svg id="svgPerfil" width="100%" height="100%"></svg></div>
          </div>
          <div class="vista-box" style="background:#FAFAFA;">
            <div class="vista-box-title">Informaci√≥n del proyecto</div>
            <div id="infoPlano" style="font-size:12px;color:#444;padding:8px;font-family:'DM Sans',sans-serif;line-height:1.8;">
              Carga un proyecto para ver la informaci√≥n.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Despiece Panel -->
    <div id="panelDespiece">
      <div class="despiece-wrap">
        <div class="despiece-header">
          <div>
            <div class="despiece-title">Listado de Despiece</div>
            <div class="despiece-meta" id="despieceMeta">‚Äî Sin proyecto cargado ‚Äî</div>
          </div>
          <div class="despiece-logo">HG Interiores<br>de Madera</div>
        </div>
        <table class="despiece-table" id="despieceTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Pieza</th>
              <th>Ancho (mm)</th>
              <th>Alto (mm)</th>
              <th>Grueso (mm)</th>
              <th>Material</th>
              <th>L1</th>
              <th>L2</th>
              <th>A1</th>
              <th>A2</th>
              <th>Color Canto</th>
            </tr>
          </thead>
          <tbody id="despieceTbody">
            <tr><td colspan="11" style="text-align:center;color:#AAA;padding:20px;">Sin datos</td></tr>
          </tbody>
        </table>
        <div class="resumen-cantos" id="resumenCantos" style="display:none;">
          <div class="resumen-title">üìè Metros lineales de canto por material</div>
          <div class="resumen-grid" id="resumenGrid"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ========== ESTADO GLOBAL ==========
let engine, scene, camera;
let piezas = [];
let meshes = [];
let proyectoActual = { cliente: '', proyecto: '', fecha: '' };

// ========== BABYLON.JS INIT ==========
window.addEventListener('DOMContentLoaded', () => {
  const canvas = document.getElementById('renderCanvas');
  engine = new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true });
  scene = crearEscena(engine, canvas);

  engine.runRenderLoop(() => { if (scene) scene.render(); });
  window.addEventListener('resize', () => engine.resize());

  setTimeout(() => {
    document.getElementById('loading').classList.add('hidden');
  }, 1800);
});

function crearEscena(engine, canvas) {
  const scene = new BABYLON.Scene(engine);
  scene.clearColor = new BABYLON.Color4(0.08, 0.08, 0.08, 1);
  scene.ambientColor = new BABYLON.Color3(1, 1, 1);

  // C√°mara
  camera = new BABYLON.ArcRotateCamera("cam", -Math.PI/4, Math.PI/3.5, 25, BABYLON.Vector3.Zero(), scene);
  camera.attachControl(canvas, true);
  camera.lowerRadiusLimit = 2;
  camera.upperRadiusLimit = 200;
  camera.wheelDeltaPercentage = 0.01;

  // Luces
  const hemi = new BABYLON.HemisphericLight("hemi", new BABYLON.Vector3(0, 1, 0), scene);
  hemi.intensity = 0.7;
  hemi.diffuse = new BABYLON.Color3(1, 0.98, 0.95);

  const dir = new BABYLON.DirectionalLight("dir", new BABYLON.Vector3(-1, -2, -1), scene);
  dir.intensity = 0.6;
  dir.position = new BABYLON.Vector3(20, 40, 20);

  // Suelo
  const ground = BABYLON.MeshBuilder.CreateGround("ground", { width: 200, height: 200 }, scene);
  const groundMat = new BABYLON.StandardMaterial("groundMat", scene);
  groundMat.diffuseColor = new BABYLON.Color3(0.1, 0.1, 0.1);
  groundMat.specularColor = new BABYLON.Color3(0, 0, 0);
  ground.material = groundMat;
  ground.position.y = 0;

  // Grid lines
  crearGrid(scene);

  return scene;
}

function crearGrid(scene) {
  const gridSize = 100;
  const step = 5;
  const lineMat = new BABYLON.StandardMaterial("gridMat", scene);
  lineMat.emissiveColor = new BABYLON.Color3(0.15, 0.15, 0.15);

  for (let i = -gridSize; i <= gridSize; i += step) {
    const lineH = BABYLON.MeshBuilder.CreateLines("gh" + i, {
      points: [new BABYLON.Vector3(-gridSize, 0.01, i), new BABYLON.Vector3(gridSize, 0.01, i)]
    }, scene);
    lineH.color = new BABYLON.Color3(0.2, 0.2, 0.2);

    const lineV = BABYLON.MeshBuilder.CreateLines("gv" + i, {
      points: [new BABYLON.Vector3(i, 0.01, -gridSize), new BABYLON.Vector3(i, 0.01, gridSize)]
    }, scene);
    lineV.color = new BABYLON.Color3(0.2, 0.2, 0.2);
  }
}

// ========== COLORES ==========
const COLORES_MATERIAL = {
  'blanco': '#F5F5F0', 'blanco brillo': '#FFFFFF', 'blanco mate': '#EBEBEB',
  'negro': '#1A1A1A', 'negro mate': '#222222', 'negro brillo': '#111111',
  'roble': '#8B6914', 'nogal': '#5C3D11', 'haya': '#C4956A',
  'gris': '#9E9E9E', 'gris claro': '#D4D4D4', 'gris oscuro': '#616161',
  'azul': '#1565C0', 'verde': '#2E7D32', 'rojo': '#C62828',
  'antracita': '#37474F', 'aluminio': '#90A4AE', 'madera natural': '#A0784A',
};

function colorParaMaterial(mat) {
  if (!mat) return '#DDDDDD';
  const key = mat.toLowerCase().trim();
  for (const [k, v] of Object.entries(COLORES_MATERIAL)) {
    if (key.includes(k)) return v;
  }
  return '#CCBBAA';
}

function hexToColor3(hex) {
  const r = parseInt(hex.slice(1,3),16)/255;
  const g = parseInt(hex.slice(3,5),16)/255;
  const b = parseInt(hex.slice(5,7),16)/255;
  return new BABYLON.Color3(r, g, b);
}

// ========== DIBUJAR MUEBLE 3D ==========
function dibujarMueble3D(data) {
  // Limpiar meshes anteriores
  meshes.forEach(m => m.dispose());
  meshes = [];

  if (!data || data.length === 0) return;

  // Escala: mm a unidades Babylon (dividir entre 100)
  const escala = 0.01;

  data.forEach((pieza, idx) => {
    const ancho = (parseFloat(pieza.ANCHO) || 100) * escala;
    const alto = (parseFloat(pieza.ALTO) || 100) * escala;
    const grueso = (parseFloat(pieza.GRUESO) || 18) * escala;
    const x = (parseFloat(pieza.X) || 0) * escala;
    const y = (parseFloat(pieza.Y) || 0) * escala;
    const z = (parseFloat(pieza.Z) || 0) * escala;

    const box = BABYLON.MeshBuilder.CreateBox(`pieza_${idx}`, {
      width: ancho,
      height: alto,
      depth: grueso
    }, scene);

    box.position = new BABYLON.Vector3(x + ancho/2, y + alto/2, z + grueso/2);

    const mat = new BABYLON.StandardMaterial(`mat_${idx}`, scene);
    const hex = colorParaMaterial(pieza.MATERIAL || pieza['COLOR.CANTO'] || '');
    mat.diffuseColor = hexToColor3(hex);
    mat.specularColor = new BABYLON.Color3(0.1, 0.1, 0.1);
    box.material = mat;

    // Wireframe edges
    const edges = new BABYLON.EdgesRenderer(box, Math.PI);
    box.edgesWidth = 1.5;
    box.edgesColor = new BABYLON.Color4(0.2, 0.2, 0.2, 0.5);
    box.enableEdgesRendering();

    box.metadata = { pieza, idx };

    box.actionManager = new BABYLON.ActionManager(scene);
    box.actionManager.registerAction(new BABYLON.ExecuteCodeAction(
      BABYLON.ActionManager.OnPickTrigger,
      () => seleccionarPieza(idx)
    ));

    meshes.push(box);
  });

  centrarCamara();
}

function seleccionarPieza(idx) {
  meshes.forEach((m, i) => {
    if (i === idx) {
      m.edgesColor = new BABYLON.Color4(0.77, 0.58, 0.42, 1);
      m.edgesWidth = 3;
    } else {
      m.edgesColor = new BABYLON.Color4(0.2, 0.2, 0.2, 0.5);
      m.edgesWidth = 1.5;
    }
  });

  document.querySelectorAll('.pieza-item').forEach((el, i) => {
    el.classList.toggle('active', i === idx);
  });
}

// ========== C√ÅMARA ==========
function setVista(tipo) {
  const vistaEl = document.getElementById('vistaActual');
  const dist = 30;
  switch(tipo) {
    case 'frente':
      camera.alpha = Math.PI;
      camera.beta = Math.PI/2;
      camera.radius = dist;
      vistaEl.textContent = 'Alzado';
      break;
    case 'lateral':
      camera.alpha = Math.PI/2;
      camera.beta = Math.PI/2;
      camera.radius = dist;
      vistaEl.textContent = 'Perfil';
      break;
    case 'planta':
      camera.alpha = 0;
      camera.beta = 0.01;
      camera.radius = dist;
      vistaEl.textContent = 'Planta';
      break;
    default:
      camera.alpha = -Math.PI/4;
      camera.beta = Math.PI/3.5;
      camera.radius = 25;
      vistaEl.textContent = 'Perspectiva';
  }
}

function centrarCamara() {
  if (meshes.length === 0) return;
  let cx=0, cy=0, cz=0;
  meshes.forEach(m => { cx+=m.position.x; cy+=m.position.y; cz+=m.position.z; });
  camera.target = new BABYLON.Vector3(cx/meshes.length, cy/meshes.length/2, cz/meshes.length);
}

// ========== CARGAR PROYECTO ==========
async function cargarProyecto() {
  const sheetId = document.getElementById('sheetId').value.trim();
  const cliente = document.getElementById('inputCliente').value.trim();
  const proyecto = document.getElementById('inputProyecto').value.trim();

  if (!sheetId || !cliente || !proyecto) {
    showToast('‚ö† Rellena el ID del Sheets, cliente y proyecto');
    return;
  }

  showToast('‚è≥ Cargando datos...');

  // URL de la API de Apps Script
  // IMPORTANTE: Reemplazar con la URL de tu Web App de Apps Script
  const url = `https://script.google.com/macros/s/TU_WEB_APP_ID/exec?action=getMuebles&sheetId=${sheetId}&cliente=${encodeURIComponent(cliente)}&proyecto=${encodeURIComponent(proyecto)}`;

  try {
    const resp = await fetch(url);
    const data = await resp.json();
    if (data && data.length > 0) {
      cargarDatos(data, cliente, proyecto);
    } else {
      showToast('‚ö† No se encontraron piezas para ese proyecto');
    }
  } catch(e) {
    showToast('‚ö† Error al conectar. Comprueba el ID del Sheets y la URL de la app.');
    console.error(e);
  }
}

function cargarEjemplo() {
  // Datos de ejemplo: un armario de 3 m√≥dulos
  const ejemplo = [
    // M√≥dulo 1 ‚Äî Armario 600mm
    { PIEZA:'Costado izq.', ANCHO:18, ALTO:2100, GRUESO:580, X:0, Y:0, Z:0, MATERIAL:'Blanco mate', 'COLOR.CANTO':'Blanco', L1:true, L2:false, A1:true, A2:false },
    { PIEZA:'Costado dcho.', ANCHO:18, ALTO:2100, GRUESO:580, X:582, Y:0, Z:0, MATERIAL:'Blanco mate', 'COLOR.CANTO':'Blanco', L1:false, L2:true, A1:true, A2:false },
    { PIEZA:'Techo', ANCHO:564, ALTO:18, GRUESO:580, X:18, Y:2082, Z:0, MATERIAL:'Blanco mate', 'COLOR.CANTO':'Blanco', L1:true, L2:true, A1:false, A2:false },
    { PIEZA:'Suelo', ANCHO:564, ALTO:18, GRUESO:580, X:18, Y:0, Z:0, MATERIAL:'Blanco mate', 'COLOR.CANTO':'Blanco', L1:true, L2:true, A1:false, A2:false },
    { PIEZA:'Balda 1', ANCHO:564, ALTO:18, GRUESO:560, X:18, Y:800, Z:10, MATERIAL:'Blanco mate', 'COLOR.CANTO':'Blanco', L1:true, L2:true, A1:false, A2:false },
    { PIEZA:'Balda 2', ANCHO:564, ALTO:18, GRUESO:560, X:18, Y:1500, Z:10, MATERIAL:'Blanco mate', 'COLOR.CANTO':'Blanco', L1:true, L2:true, A1:false, A2:false },
    { PIEZA:'Respaldo', ANCHO:564, ALTO:2064, GRUESO:8, X:18, Y:18, Z:572, MATERIAL:'Blanco mate', 'COLOR.CANTO':'Blanco', L1:false, L2:false, A1:false, A2:false },
    { PIEZA:'Puerta izq.', ANCHO:300, ALTO:2100, GRUESO:18, X:0, Y:0, Z:-20, MATERIAL:'Blanco brillo', 'COLOR.CANTO':'Blanco', L1:true, L2:true, A1:true, A2:true },
    { PIEZA:'Puerta dcha.', ANCHO:300, ALTO:2100, GRUESO:18, X:300, Y:0, Z:-20, MATERIAL:'Blanco brillo', 'COLOR.CANTO':'Blanco', L1:true, L2:true, A1:true, A2:true },
  ];

  cargarDatos(ejemplo, 'Cliente Ejemplo', 'Armario Dormitorio');
}

function cargarDatos(data, cliente, proyecto) {
  piezas = data;
  proyectoActual = { cliente, proyecto, fecha: new Date().toLocaleDateString('es-ES') };

  document.getElementById('projectBadge').textContent = `${cliente} ‚Äî ${proyecto}`;

  dibujarMueble3D(data);
  renderizarListaPiezas(data);
  actualizarEstadisticas(data);
  generarDespiece(data);
  generarPlanos2D(data);

  showToast(`‚úì ${data.length} piezas cargadas correctamente`);
}

// ========== LISTA PIEZAS ==========
function renderizarListaPiezas(data) {
  const container = document.getElementById('piezasList');
  container.innerHTML = '';

  data.forEach((p, i) => {
    const hex = colorParaMaterial(p.MATERIAL || '');
    const cantos = [];
    if (p.L1) cantos.push('L1');
    if (p.L2) cantos.push('L2');
    if (p.A1) cantos.push('A1');
    if (p.A2) cantos.push('A2');

    const div = document.createElement('div');
    div.className = 'pieza-item';
    div.innerHTML = `
      <div class="pieza-color" style="background:${hex}; border:1px solid rgba(255,255,255,0.1)"></div>
      <div style="flex:1;min-width:0;">
        <div class="pieza-name">${p.PIEZA || `Pieza ${i+1}`}</div>
        <div class="pieza-dim">${p.ANCHO}√ó${p.ALTO}√ó${p.GRUESO} mm ¬∑ ${p.MATERIAL || '‚Äî'}</div>
        ${cantos.length > 0 ? `<div class="cantos-row">${cantos.map(c=>`<span class="canto-badge">${c}</span>`).join('')}</div>` : ''}
      </div>
    `;
    div.onclick = () => seleccionarPieza(i);
    container.appendChild(div);
  });
}

// ========== ESTAD√çSTICAS ==========
function actualizarEstadisticas(data) {
  document.getElementById('statPiezas').textContent = data.length;

  const mats = [...new Set(data.map(p => p.MATERIAL).filter(Boolean))];
  document.getElementById('statMateriales').textContent = mats.length > 0 ? mats.slice(0,2).join(', ') + (mats.length > 2 ? '...' : '') : '‚Äî';

  let totalCanto = 0;
  data.forEach(p => {
    const ancho = parseFloat(p.ANCHO) || 0;
    const alto = parseFloat(p.ALTO) || 0;
    if (p.L1) totalCanto += alto;
    if (p.L2) totalCanto += alto;
    if (p.A1) totalCanto += ancho;
    if (p.A2) totalCanto += ancho;
  });

  document.getElementById('statCanto').textContent = (totalCanto/1000).toFixed(2) + ' m';
}

// ========== DESPIECE ==========
function generarDespiece(data) {
  const tbody = document.getElementById('despieceTbody');
  const meta = document.getElementById('despieceMeta');

  meta.textContent = `${proyectoActual.cliente} ‚Äî ${proyectoActual.proyecto} ‚Äî ${proyectoActual.fecha}`;

  tbody.innerHTML = '';

  data.forEach((p, i) => {
    const si = '<span class="canto-si">‚úì</span>';
    const no = '<span class="canto-no">‚Äî</span>';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td><b>${p.PIEZA || `Pieza ${i+1}`}</b></td>
      <td>${p.ANCHO}</td>
      <td>${p.ALTO}</td>
      <td>${p.GRUESO}</td>
      <td>${p.MATERIAL || '‚Äî'}</td>
      <td>${p.L1 ? si : no}</td>
      <td>${p.L2 ? si : no}</td>
      <td>${p.A1 ? si : no}</td>
      <td>${p.A2 ? si : no}</td>
      <td>${p['COLOR.CANTO'] || '‚Äî'}</td>
    `;
    tbody.appendChild(tr);
  });

  // Resumen cantos por material
  const cantosPorMat = {};
  data.forEach(p => {
    const mat = p['COLOR.CANTO'] || p.MATERIAL || 'Sin especificar';
    if (!cantosPorMat[mat]) cantosPorMat[mat] = 0;
    const ancho = parseFloat(p.ANCHO) || 0;
    const alto = parseFloat(p.ALTO) || 0;
    if (p.L1) cantosPorMat[mat] += alto;
    if (p.L2) cantosPorMat[mat] += alto;
    if (p.A1) cantosPorMat[mat] += ancho;
    if (p.A2) cantosPorMat[mat] += ancho;
  });

  const resumenGrid = document.getElementById('resumenGrid');
  resumenGrid.innerHTML = '';

  Object.entries(cantosPorMat).forEach(([mat, mm]) => {
    if (mm > 0) {
      const metros = (mm/1000).toFixed(2);
      const div = document.createElement('div');
      div.className = 'resumen-item';
      div.innerHTML = `<div class="resumen-mat">${mat}</div><div class="resumen-metros">${metros}<span class="resumen-unit"> m</span></div>`;
      resumenGrid.appendChild(div);
    }
  });

  document.getElementById('resumenCantos').style.display = 'block';
}

// ========== PLANOS 2D SVG ==========
function generarPlanos2D(data) {
  if (!data || data.length === 0) return;

  const { cliente, proyecto, fecha } = proyectoActual;
  document.getElementById('plano2dSub').textContent = `${cliente} ‚Äî ${proyecto} ‚Äî ${fecha}`;

  const info = document.getElementById('infoPlano');
  const mats = [...new Set(data.map(p => p.MATERIAL).filter(Boolean))];
  info.innerHTML = `
    <b>Cliente:</b> ${cliente}<br>
    <b>Proyecto:</b> ${proyecto}<br>
    <b>Fecha:</b> ${fecha}<br>
    <b>Total piezas:</b> ${data.length}<br>
    <b>Materiales:</b> ${mats.join(', ') || '‚Äî'}<br>
  `;

  dibujarVistaSVG('svgAlzado', data, 'alzado');
  dibujarVistaSVG('svgPlanta', data, 'planta');
  dibujarVistaSVG('svgPerfil', data, 'perfil');
}

function dibujarVistaSVG(svgId, data, vista) {
  const svg = document.getElementById(svgId);
  svg.innerHTML = '';

  const W = svg.clientWidth || 300;
  const H = svg.clientHeight || 220;
  const padding = 30;

  // Calcular bounding box seg√∫n vista
  let minX=Infinity, maxX=-Infinity, minY=Infinity, maxY=-Infinity;

  data.forEach(p => {
    const px = parseFloat(p.X)||0, py = parseFloat(p.Y)||0, pz = parseFloat(p.Z)||0;
    const pw = parseFloat(p.ANCHO)||0, ph = parseFloat(p.ALTO)||0, pd = parseFloat(p.GRUESO)||0;

    let x1, x2, y1, y2;
    if (vista === 'alzado') { x1=px; x2=px+pw; y1=py; y2=py+ph; }
    else if (vista === 'planta') { x1=px; x2=px+pw; y1=pz; y2=pz+pd; }
    else { x1=pz; x2=pz+pd; y1=py; y2=py+ph; }

    minX=Math.min(minX,x1); maxX=Math.max(maxX,x2);
    minY=Math.min(minY,y1); maxY=Math.max(maxY,y2);
  });

  const rangeX = maxX - minX || 1;
  const rangeY = maxY - minY || 1;
  const scaleX = (W - padding*2) / rangeX;
  const scaleY = (H - padding*2) / rangeY;
  const scale = Math.min(scaleX, scaleY);
  const offsetX = padding + (W - padding*2 - rangeX*scale)/2 - minX*scale;
  const offsetY = padding + (H - padding*2 - rangeY*scale)/2 - minY*scale;

  // Fondo
  const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
  rect.setAttribute('width',W); rect.setAttribute('height',H);
  rect.setAttribute('fill','#FAFAFA');
  svg.appendChild(rect);

  // Dibujar piezas
  data.forEach(p => {
    const px=parseFloat(p.X)||0, py=parseFloat(p.Y)||0, pz=parseFloat(p.Z)||0;
    const pw=parseFloat(p.ANCHO)||0, ph=parseFloat(p.ALTO)||0, pd=parseFloat(p.GRUESO)||0;

    let rx, ry, rw, rh;
    if (vista === 'alzado') { rx=px; ry=maxY-(py+ph); rw=pw; rh=ph; }
    else if (vista === 'planta') { rx=px; ry=pz; rw=pw; rh=pd; }
    else { rx=pz; ry=maxY-(py+ph); rw=pd; rh=ph; }

    const svgX = rx*scale + offsetX;
    const svgY = ry*scale + offsetY;
    const svgW = Math.max(rw*scale, 1);
    const svgH = Math.max(rh*scale, 1);

    const hex = colorParaMaterial(p.MATERIAL||'');

    const r = document.createElementNS('http://www.w3.org/2000/svg','rect');
    r.setAttribute('x', svgX); r.setAttribute('y', svgY);
    r.setAttribute('width', svgW); r.setAttribute('height', svgH);
    r.setAttribute('fill', hex); r.setAttribute('stroke', '#5C3D1E');
    r.setAttribute('stroke-width', '0.8'); r.setAttribute('fill-opacity', '0.85');
    svg.appendChild(r);
  });

  // Cotas externas
  dibujarCota(svg, padding, H-12, W-padding, H-12, `${Math.round(rangeX)} mm`, 'H');
  dibujarCota(svg, 10, padding, 10, H-padding, `${Math.round(rangeY)} mm`, 'V');
}

function dibujarCota(svg, x1, y1, x2, y2, texto, dir) {
  const ns = 'http://www.w3.org/2000/svg';

  const line = document.createElementNS(ns, 'line');
  line.setAttribute('x1',x1); line.setAttribute('y1',y1);
  line.setAttribute('x2',x2); line.setAttribute('y2',y2);
  line.setAttribute('stroke','#8B5E3C'); line.setAttribute('stroke-width','1');
  svg.appendChild(line);

  const t = document.createElementNS(ns, 'text');
  t.setAttribute('fill','#5C3D1E'); t.setAttribute('font-size','9');
  t.setAttribute('font-family','DM Sans, sans-serif'); t.setAttribute('font-weight','600');
  t.setAttribute('text-anchor','middle');

  if (dir === 'H') {
    t.setAttribute('x', (x1+x2)/2); t.setAttribute('y', y1-3);
  } else {
    t.setAttribute('transform', `rotate(-90, ${x1-3}, ${(y1+y2)/2})`);
    t.setAttribute('x', x1-3); t.setAttribute('y', (y1+y2)/2);
  }
  t.textContent = texto;
  svg.appendChild(t);
}

// ========== TABS ==========
function switchTab(tab) {
  document.getElementById('container3d').style.display = 'none';
  document.getElementById('panel2d').classList.remove('visible');
  document.getElementById('panelDespiece').classList.remove('visible');

  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

  if (tab === '3d') {
    document.getElementById('container3d').style.display = 'block';
    document.getElementById('tab3d').classList.add('active');
    engine.resize();
  } else if (tab === '2d') {
    document.getElementById('panel2d').classList.add('visible');
    document.getElementById('tab2d').classList.add('active');
    if (piezas.length > 0) generarPlanos2D(piezas);
  } else {
    document.getElementById('panelDespiece').classList.add('visible');
    document.getElementById('tabDespiece').classList.add('active');
  }
}

function mostrar2D() { switchTab('2d'); }

// ========== EXPORTAR PDF ==========
function exportarPDF() {
  if (piezas.length === 0) { showToast('‚ö† Carga un proyecto primero'); return; }
  window.print();
  showToast('üìÑ Abriendo di√°logo de impresi√≥n...');
}

// ========== EXPORTAR DXF ==========
function exportarDXF() {
  if (piezas.length === 0) { showToast('‚ö† Carga un proyecto primero'); return; }

  let dxf = '0\nSECTION\n2\nHEADER\n0\nENDSEC\n0\nSECTION\n2\nENTITIES\n';

  piezas.forEach((p, i) => {
    const x = parseFloat(p.X)||0, y = parseFloat(p.Y)||0;
    const w = parseFloat(p.ANCHO)||0, h = parseFloat(p.ALTO)||0;

    dxf += `0\nLWPOLYLINE\n8\nDESPIECE\n90\n4\n70\n1\n`;
    dxf += `10\n${x}\n20\n${y}\n`;
    dxf += `10\n${x+w}\n20\n${y}\n`;
    dxf += `10\n${x+w}\n20\n${y+h}\n`;
    dxf += `10\n${x}\n20\n${y+h}\n`;
    dxf += `0\nTEXT\n8\nTEXTO\n10\n${x+2}\n20\n${y+h/2}\n40\n20\n1\n${p.PIEZA||i+1}\n`;
  });

  dxf += '0\nENDSEC\n0\nEOF';

  const blob = new Blob([dxf], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${proyectoActual.proyecto || 'planos'}_despiece.dxf`;
  a.click();
  showToast('üìê Archivo DXF generado');
}

// ========== VOLVER ==========
function volverApps() {
  if (window.opener) window.close();
  else history.back();
}

// ========== TOAST ==========
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}
</script>
</body>
</html>
